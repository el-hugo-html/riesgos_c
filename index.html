<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Eventos y Formulario</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="text-gray-800 font-sans" style="background-image: url('montana.png'); background-size: cover; background-position: center; background-attachment: fixed;">

  <div class="container mx-auto p-4 relative">
    <h2 class="text-3xl font-bold text-center mb-2 text-blue-700">Reporte de Evento de Riesgo Cordillerano</h2>
    <p class="text-center mb-6 text-gray-600">Haz clic en el mapa para agregar un punto y llenar el formulario.</p>

    <div class="relative h-[75vh] w-full mb-8 rounded-xl shadow-lg border-2 border-white overflow-hidden">
      <div id="map" class="h-full w-full z-0"></div>

      <!-- Panel de Filtros -->
      <div class="absolute bottom-4 left-12 z-[1000] bg-white p-4 rounded-xl shadow-2xl max-w-xs">
        <h3 class="text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Capas</h3>
        <div class="space-y-2">
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" value="deslizamiento" class="filter-checkbox form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
            <span class="text-sm text-gray-700">Deslizamiento</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" value="tormenta" class="filter-checkbox form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
            <span class="text-sm text-gray-700">Tormenta convectiva</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" value="volcan" class="filter-checkbox form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
            <span class="text-sm text-gray-700">Actividad volc√°nica</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" value="alud" class="filter-checkbox form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
            <span class="text-sm text-gray-700">Alud</span>
          </label>
        </div>
        
        <div class="mt-4 pt-4 border-t border-gray-200">
          <h3 class="text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Filtrar por Fecha</h3>
          <div class="space-y-2">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="checkbox" id="filtroFechaToggle" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
              <span class="text-sm text-gray-700">Filtrar por fecha</span>
            </label>
            <input type="date" id="filtroFecha" disabled class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none disabled:bg-gray-100">
          </div>
          <div id="resumenEventos" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded hidden">
            <h4 class="text-xs font-bold text-blue-700 mb-2 uppercase">Resumen de Eventos</h4>
            <div id="resumenContenido" class="text-xs text-blue-700 space-y-1"></div>
          </div>
        </div>
        
        <div class="mt-4 pt-4 border-t border-gray-200">
          <button id="btnMedir" class="w-full flex items-center justify-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded transition text-sm border border-gray-300">
            <span>Medir Distancia</span>
          </button>
          <p id="medidaResultado" class="text-center text-xs text-gray-500 mt-2 hidden">Arrastra para medir</p>
        </div>
      </div>

      <div class="absolute top-4 right-4 z-[1000] max-w-sm w-full bg-white p-4 rounded-xl shadow-2xl hidden max-h-[calc(100%-2rem)] overflow-y-auto" id="formBox">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
          <h3 class="text-lg font-semibold text-gray-800">Formulario del Evento</h3>
          <button type="button" onclick="document.getElementById('formBox').classList.add('hidden')" class="text-gray-500 hover:text-red-500 font-bold text-xl">&times;</button>
        </div>

        <form id="eventoForm" class="space-y-3">

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Latitud</label>
              <input type="text" id="lat" name="lat" readonly class="w-full p-2 bg-gray-100 border border-gray-300 rounded text-xs text-gray-600 focus:outline-none">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Longitud</label>
              <input type="text" id="lng" name="lng" readonly class="w-full p-2 bg-gray-100 border border-gray-300 rounded text-xs text-gray-600 focus:outline-none">
            </div>
          </div>

          <div>
            <label for="evento" class="block text-sm font-medium text-gray-700 mb-1">Tipo de evento</label>
            <select id="evento" name="evento" required class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <option value="">Seleccione‚Ä¶</option>
              <option value="deslizamiento">Deslizamiento</option>
              <option value="tormenta">Tormenta convectiva</option>
              <option value="volcan">Actividad volc√°nica</option>
              <option value="alud">Alud</option>
            </select>
          </div>

          <div>
            <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">Fecha del evento</label>
            <input type="datetime-local" id="fecha" name="fecha" required class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none">
          </div>

          <div id="extraFields" class="space-y-2 p-2 bg-gray-50 rounded border border-gray-200 empty:hidden"></div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Imagen del suceso</label>
            <input type="file" id="foto" name="foto" accept="image/png,image/jpeg" required class="w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition">
          </div>

          <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-sm">
            Enviar Reporte
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = "https://iktdhszjkirxxtufyivl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrdGRoc3pqa2lyeHh0dWZ5aXZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNDU2NjQsImV4cCI6MjA4MDYyMTY2NH0.HNdPh-wmFXJvRn5vF2IR0r23CEu-ik-eiiKkXNnQHlU";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    var map = L.map('map').setView([ -33.45, -70.66 ], 6);
    var marker = null;
    var markersLayer = L.layerGroup().addTo(map); 
    var todosLosEventos = []; 

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    map.on('click', function (e) {
      if (isMeasuring) return; 

      var lat = e.latlng.lat;
      var lng = e.latlng.lng;

      if (marker) map.removeLayer(marker);

      marker = L.marker([lat, lng]).addTo(map);

      const formBox = document.getElementById('formBox');
      formBox.classList.remove('hidden');

      
      document.getElementById('lat').value = lat.toFixed(6);
      document.getElementById('lng').value = lng.toFixed(6);
    });

    document.getElementById('evento').addEventListener('change', function () {
      var tipo = this.value;
      var extra = document.getElementById('extraFields');
      extra.innerHTML = "";

      const createInput = (label, name) => `
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">${label}</label>
          <input type="text" name="${name}" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none">
        </div>`;
      
      const createSelect = (label, name) => `
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">${label}</label>
          <select name="${name}" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none">
            <option value="">Seleccione‚Ä¶</option>
            <option value="si">S√≠</option>
            <option value="no">No</option>
          </select>
        </div>`;

      if (tipo === "deslizamiento") {
        extra.innerHTML = 
          createInput("Tipo de material desplegado", "material") +
          createInput("Mecanismo de activaci√≥n", "mecanismo") +
          createInput("Da√±os observados", "danios");
      }
      else if (tipo === "tormenta") {
        extra.innerHTML = 
          createInput("Duraci√≥n del evento", "duracion") +
          createInput("Longitud de viaje del evento", "longitudViaje") +
          createInput("Direcci√≥n de viaje del evento", "direccionViaje");
      }
      else if (tipo === "volcan") {
        extra.innerHTML = 
          createSelect("Ca√≠da de ceniza", "ceniza") +
          createSelect("Flujos de lava", "lava") +
          createSelect("Lahares", "lahares") +
          createSelect("Sismicidad", "sismicidad");
      }
      else if (tipo === "alud") {
        extra.innerHTML = 
          createInput("Tipo de desprendimiento", "desprendimiento") +
          createInput("Orientaci√≥n de la pendiente", "orientacion") +
          createInput("Contribuyentes de activaci√≥n", "contribuyentes");
      }
    });

    document.getElementById('eventoForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerText;
      submitBtn.disabled = true;
      submitBtn.innerText = "Enviando...";
      submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

      try {
        const lat = document.getElementById('lat').value;
        const lng = document.getElementById('lng').value;
        const tipo = document.getElementById('evento').value;
        const fecha = document.getElementById('fecha').value;

        const extraFields = {};
        document.querySelectorAll('#extraFields [name]').forEach(inp => {
          extraFields[inp.name] = inp.value;
        });

        const fotoFile = document.getElementById('foto').files[0];
        const fileName = `${crypto.randomUUID()}-${fotoFile.name}`;

        const { data: uploadData, error: uploadError } = await supabaseClient
          .storage
          .from("eventos-fotos")
          .upload(fileName, fotoFile);

        if (uploadError) throw uploadError;

        const { error } = await supabaseClient
          .from("eventos")
          .insert([{
            lat: parseFloat(lat),
            lng: parseFloat(lng),
            evento: tipo,
            fecha: fecha,
            datos: extraFields,
            estado: "pendiente",
            foto_path: uploadData.path
          }]);

        if (error) throw error;

        alert("¬°Evento enviado para revisi√≥n!");
        document.getElementById('formBox').classList.add('hidden');
        this.reset();
        document.getElementById('extraFields').innerHTML = '';
        if (marker) map.removeLayer(marker);
        marker = null;

      } catch (error) {
        console.error(error);
        alert("Error al procesar la solicitud: " + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = originalBtnText;
        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    });

    async function cargarEventosAprobados() {
      const { data, error } = await supabaseClient
        .from("eventos")
        .select("*")
        .eq("estado", "aprobado");

      if (error) {
        console.error("Error cargando eventos:", error);
        return;
      }

      todosLosEventos = data;
      aplicarFiltros();
    }

    function aplicarFiltros() {
      markersLayer.clearLayers(); 

      const checkboxes = document.querySelectorAll('.filter-checkbox:checked');
      const tiposSeleccionados = Array.from(checkboxes).map(cb => cb.value);

      const filtroFechaToggle = document.getElementById('filtroFechaToggle').checked;
      const filtroFechaInput = document.getElementById('filtroFecha').value;
      const resumenEventos = document.getElementById('resumenEventos');
      const resumenContenido = document.getElementById('resumenContenido');

      const colores = {
        'deslizamiento': '#FFD700',
        'tormenta': '#0066FF',
        'volcan': '#FF0000',
        'alud': '#FFFFFF'
      };

      const nombreEventos = {
        'deslizamiento': 'Deslizamiento',
        'tormenta': 'Tormenta convectiva',
        'volcan': 'Actividad volc√°nica',
        'alud': 'Alud'
      };

      const gatillantes = ['tormenta', 'volcan'];
      const secundarios = ['deslizamiento', 'alud'];

      const crearIconoSVG = (color) => {
        const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="41">
          <path d="M12 0C7.58 0 4 3.58 4 8c0 5.25 8 16 8 16s8-10.75 8-16c0-4.42-3.58-8-8-8z" fill="${color}" stroke="#333" stroke-width="0.5"/>
          <circle cx="12" cy="8" r="3" fill="#333"/>
        </svg>`;
        
        return `data:image/svg+xml;base64,${btoa(svgIcon)}`;
      };

      const resumenPorTipo = {};
      let eventosMostrados = 0;
      let eventosGatillantes = [];
      let eventosSecundarios = [];

      todosLosEventos.forEach(ev => {

        if (!tiposSeleccionados.includes(ev.evento)) return;

        if (filtroFechaToggle && filtroFechaInput) {
          const fechaEvento = ev.fecha ? ev.fecha.split('T')[0] : null;
          if (fechaEvento !== filtroFechaInput) return;
        }

        eventosMostrados++;
        if (filtroFechaToggle && filtroFechaInput) {
          resumenPorTipo[ev.evento] = (resumenPorTipo[ev.evento] || 0) + 1;
          
          if (gatillantes.includes(ev.evento)) {
            eventosGatillantes.push(ev);
          } else if (secundarios.includes(ev.evento)) {
            eventosSecundarios.push(ev);
          }
        }

        const fotoURL = `${SUPABASE_URL}/storage/v1/object/public/eventos-fotos/${ev.foto_path}`;
        const color = colores[ev.evento] || '#0066FF';

        const fechaFormato = ev.fecha ? new Date(ev.fecha).toLocaleString('es-CL') : 'Fecha no disponible';

        const customIcon = L.icon({
          iconUrl: crearIconoSVG(color),
          shadowUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNSA0MSI+PHBhdGggZD0iTTAgMjVsMTIuNSAxNkwxMDAgNXoiIGZpbGw9IiMwMDAiIG9wYWNpdHk9IjAuMiIvPjwvc3ZnPg==',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });

        L.marker([ev.lat, ev.lng], { icon: customIcon })
          .addTo(markersLayer)
          .bindPopup(`
            <div class="text-center">
              <b class="text-lg capitalize text-blue-600">${ev.evento}</b><br>
              <small class="text-gray-600">${fechaFormato}</small><br>
              <img src="${fotoURL}" class="w-32 h-auto mx-auto my-2 rounded shadow"><br>
              <div class="text-left text-xs bg-gray-100 p-2 rounded max-h-32 overflow-auto">
                ${Object.entries(ev.datos).map(([k, v]) => `<strong>${k}:</strong> ${v}<br>`).join('')}
              </div>
            </div>`);
      });

      // Dibujar l√≠neas de gatillantes a secundarios (solo la l√≠nea m√°s corta por secundario)
      if (filtroFechaToggle && filtroFechaInput && eventosGatillantes.length > 0 && eventosSecundarios.length > 0) {
        eventosSecundarios.forEach(secundario => {
          let gatillantesCercano = null;
          let distanciaMinima = Infinity;

          eventosGatillantes.forEach(gatillante => {
            const latlng1 = [gatillante.lat, gatillante.lng];
            const latlng2 = [secundario.lat, secundario.lng];
            const distancia = L.latLng(latlng1).distanceTo(L.latLng(latlng2));

            if (distancia < distanciaMinima) {
              distanciaMinima = distancia;
              gatillantesCercano = gatillante;
            }
          });

          if (gatillantesCercano) {
            const latlng1 = [gatillantesCercano.lat, gatillantesCercano.lng];
            const latlng2 = [secundario.lat, secundario.lng];
            
            let distanciaTexto = '';
            if (distanciaMinima >= 1000) {
              distanciaTexto = (distanciaMinima / 1000).toFixed(2) + ' km';
            } else {
              distanciaTexto = Math.round(distanciaMinima) + ' m';
            }

            const polyline = L.polyline([latlng1, latlng2], {
              color: 'red',
              weight: 2,
              opacity: 0.7,
              dashArray: '5, 5'
            }).addTo(markersLayer);

            const midpoint = L.latLng(
              (latlng1[0] + latlng2[0]) / 2,
              (latlng1[1] + latlng2[1]) / 2
            );

            L.tooltip({
              permanent: true,
              direction: 'center',
              className: 'bg-red-100 border border-red-500 text-red-800 text-xs font-bold px-2 py-1 rounded'
            })
              .setLatLng(midpoint)
              .setContent(distanciaTexto)
              .addTo(markersLayer);
          }
        });
      }

      if (filtroFechaToggle && filtroFechaInput && eventosMostrados > 0) {
        let html = '';
        Object.entries(resumenPorTipo).forEach(([tipo, cantidad]) => {
          html += `<div class="flex justify-between"><span>${nombreEventos[tipo]}:</span><strong>${cantidad}</strong></div>`;
        });
        html += `<div class="border-t border-blue-200 mt-2 pt-2 flex justify-between font-bold"><span>Total:</span><strong>${eventosMostrados}</strong></div>`;
        resumenContenido.innerHTML = html;
        resumenEventos.classList.remove('hidden');
      } else {
        resumenEventos.classList.add('hidden');
      }
    }


    document.querySelectorAll('.filter-checkbox').forEach(cb => {
      cb.addEventListener('change', aplicarFiltros);
    });

    const filtroFechaToggle = document.getElementById('filtroFechaToggle');
    const filtroFechaInput = document.getElementById('filtroFecha');

    filtroFechaToggle.addEventListener('change', function() {
      filtroFechaInput.disabled = !this.checked;
      aplicarFiltros();
    });

    filtroFechaInput.addEventListener('change', aplicarFiltros);


    let isMeasuring = false;
    let measureLine = null;
    let measureTooltip = null;
    let startPoint = null;

    const btnMedir = document.getElementById('btnMedir');
    const medidaResultado = document.getElementById('medidaResultado');

    btnMedir.addEventListener('click', () => {
      isMeasuring = !isMeasuring;
      
      if (isMeasuring) {
        btnMedir.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
        btnMedir.innerHTML = '<span>‚ùå</span><span>Cancelar Medici√≥n</span>';
        medidaResultado.classList.remove('hidden');
        medidaResultado.innerText = "Haz click y arrastra para medir";
        map.getContainer().style.cursor = 'crosshair';
        map.dragging.disable(); 
      } else {
        resetMeasurement();
      }
    });

    function resetMeasurement() {
      isMeasuring = false;
      btnMedir.classList.remove('bg-blue-100', 'text-blue-700', 'border-blue-300');
      btnMedir.innerHTML = '<span>üìè</span><span>Medir Distancia</span>';
      medidaResultado.classList.add('hidden');
      map.getContainer().style.cursor = '';
      map.dragging.enable();
      
      if (measureLine) map.removeLayer(measureLine);
      if (measureTooltip) map.removeLayer(measureTooltip);
      measureLine = null;
      measureTooltip = null;
      startPoint = null;
    }

    map.on('mousedown', function(e) {
      if (!isMeasuring) return;
      

      if (measureLine) map.removeLayer(measureLine);
      if (measureTooltip) map.removeLayer(measureTooltip);

      startPoint = e.latlng;
      
      measureLine = L.polyline([startPoint, startPoint], { color: 'red', weight: 3, dashArray: '5, 10' }).addTo(map);
      
      measureTooltip = L.tooltip({ permanent: true, direction: 'right', className: 'bg-white border border-gray-300 px-2 py-1 rounded shadow text-xs font-bold' })
        .setLatLng(startPoint)
        .setContent("0 m")
        .addTo(map);
    });

    map.on('mousemove', function(e) {
      if (!isMeasuring || !startPoint) return;

      const currentPoint = e.latlng;
      measureLine.setLatLngs([startPoint, currentPoint]);

      const distance = startPoint.distanceTo(currentPoint);
      let distanceText = "";
      
      if (distance >= 1000) {
        distanceText = (distance / 1000).toFixed(2) + " km";
      } else {
        distanceText = Math.round(distance) + " m";
      }

      measureTooltip.setLatLng(currentPoint).setContent(distanceText);
      medidaResultado.innerText = `Distancia: ${distanceText}`;
    });

    map.on('mouseup', function() {
      if (isMeasuring && startPoint) {
        startPoint = null;
      }
    });

    cargarEventosAprobados();
  </script>

</body>
</html>
